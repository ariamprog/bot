import os
import gradio as gr
import webbrowser
import string
import re
from difflib import get_close_matches
from datetime import datetime
import google.generativeai as genai
import json

GEMINI_API_KEY = "AIzaSyCrOdJmn1rwb88BAApsTRtvAu247-Fpqpg" 
GEMINI_MODEL = "gemini-1.5-flash"
GEMINI_ENABLED = False

# ------------------------------------
# 2. ุชุนุฑูู ุฏูุงู ุงูุชููุฆุฉ ูุงูุงุชุตุงู (ูุจู ุงูุงุณุชุฏุนุงุก)
# ------------------------------------

def setup_gemini():
    """ูููุฆ ุนููู Gemini ุจุงุณุชุฎุฏุงู ุงูููุชุงุญ ุงููุนุฑูู."""
    global GEMINI_ENABLED
    try:
        # ููุถู ุฏุงุฆูุงู ุงุณุชุฎุฏุงู os.environ ูุชุนููู ุงูููุชุงุญ
        os.environ["GEMINI_API_KEY"] = GEMINI_API_KEY 

        # ุงูุชุญูู ูู ุฃู ุงูููุชุงุญ ุบูุฑ ูุงุฑุบ ุฃู ูู ูุชู ุชุฑูู ููููุฉ ููููุฉ
        if GEMINI_API_KEY and "AIzaSy" in GEMINI_API_KEY:
            # ููุง ูุณุชุฎุฏู genai.Client() ูุจุงุดุฑุฉ ูุชุฌุฑุจุฉ ุงูุงุชุตุงู ุจุฏูุงู ูู genai.configure()
            # ุงุณุชุฏุนุงุก ุงูุนููู ููุง ุณูุคูุฏ ุฃู ุงูููุชุงุญ ูุนูู.
            client = genai.Client() 
            # ุฅุฐุง ูู ุชุธูุฑ ุฃุฎุทุงุกุ ูุงูููุชุงุญ ุตุงูุญ.
            GEMINI_ENABLED = True
            print("โ Gemini client initialized successfully.")
        else:
            print("โ๏ธ GEMINI_API_KEY ููููุฏ ุฃู ุบูุฑ ุตุญูุญ.")
            GEMINI_ENABLED = False
            
    except Exception as e:
        print(f"โ๏ธ ูุดู ุชููุฆุฉ Gemini: {e}")
        GEMINI_ENABLED = False

def call_gemini_api(user_question, local_context_text=""):
    """ุชุชุตู ุจูููุฐุฌ Gemini ุจูุงุกู ุนูู ุชุนูููุงุช ุงููุธุงู."""
    if not GEMINI_ENABLED:
        return "โ๏ธ ุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุบูุฑ ููุนูุฉ ุญุงููุงู (ุชุฃูุฏ ูู ููุชุงุญ API)."
    try:
        # ๐ก ุชู ุชุนุฏูู ุงูุชุนูููุงุช ููุณูุงุญ ุจุงูุฑุฏูุฏ ุงูุนุงูุฉ ุนูุฏ ุนุฏู ูุฌูุฏ ุณูุงู ูุญูู
        system_instructions = (
            "ุฃูุช ูุณุงุนุฏ ูุฑุดุฏ ูููููุฉ ุงูุชูููุฉ ุงูุฑูููุฉ ุจุฌุฏุฉ. "
            "ุฃุฌูุจู ุจุงุฎุชุตุงุฑ ู ุจูุบุฉ ูุจุณุทุฉ ููุทููุฉ. "
            "**ุงุนุชูุฏู ุฃููุงู ุนูู ุงููุนูููุงุช ุงููุญููุฉ ุงููุฏุฑุฌุฉ (LOCAL_CONTEXT) ูุงุณุชุฎุฑุฌู ุงูุฅุฌุงุจุฉ ูููุง.** "
            "**ุฅุฐุง ูู ุชูู ุงูุฅุฌุงุจุฉ ููุฌูุฏุฉ ูู ุงููุนูููุงุช ุงููุญููุฉุ ุงุณุชุฎุฏูู ูุนุฑูุชู ุงูุนุงูุฉ ููุฑุฏ ุนูู ุงูุณุคุงู.**" 
        )

        prompt = f"{system_instructions}\n\nLOCAL_CONTEXT:\n{local_context_text}\n\nุงูุณุคุงู:\n{user_question}\n\nุงูุฑุฏ:"
        
        # ูุณุชุฎุฏู genai.Client() ุฏุงุฎู ุฏุงูุฉ ุงูุงุชุตุงู ูุถูุงู ุงุณุชุฎุฏุงู ุงูููุชุงุญ ุงูููููุฃ
        client = genai.Client()
        response = client.models.generate_content(prompt, model=GEMINI_MODEL)

        if response and response.text:
            return response.text.strip()
            
        return "โ๏ธ ูู ุฃุณุชุทุน ุชูููุฏ ุฅุฌุงุจุฉ ูู ุงูููุช ุงูุญุงูู."
    except Exception as e:
        print(f"Gemini Error: {e}") 
        return "ุงุนุชุฐุฑุ ูุงุฌูุช ูุดููุฉ ุชูููุฉ ูู ุงูุงุชุตุงู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู."

# ------------------------------------
# 3. ุงูููุทู ุงูุฑุฆูุณู (ุงุณุชุฏุนุงุก ุงูุชููุฆุฉ)
# ------------------------------------

setup_gemini() # ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ูุชุดุบูู ุงูุชููุฆุฉ
# ... ุจููุฉ ููุฏ Gradio ูุจุฏุฃ ููุง
# ุฑุงุจุท ูุงุชุณุงุจ
whatsapp_link = "https://wa.me/qr/YQ5U5MAW36FAP1"
def launch_whatsapp_button():
    webbrowser.open_new_tab(whatsapp_link)
    return None

# ============================
# 2๏ธโฃ ุงูุจูุงูุงุช ูููุงุนุฏ ุงูุจุญุซ
# ============================
PLACES = {
    "ุงููุณุฑุญ": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ญ ุงููุณุฑุญ ูู ุงูุฏูุฑ ุงูุฃุฑุถู ูุฑุจ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉุ ุนูู ูุณุงุฑู ุนูุฏ ุงูุฏุฎูู."
    },
    "ุงููุงูุชูุฑูุง": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "โ๏ธ ุงููุงูุชูุฑูุง ูู ุงูุฏูุฑ ุงูุฃุฑุถู ุจุฌุงูุจ ุงูุณูุงูู ุฌุงูุจ ูุณู C ."
    },
    "ููุงุชุจ ุงูุฅุฏุงุฑุฉ": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ข   ููุงุชุจ ุงูุฅุฏุงุฑุฉ ุนูุฏ ูุฏุฎู ุงููููุฉุ ูุจุงุดุฑุฉ ุจุนุฏ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ."
    },
    "ุงูููุชุจุฉ": {
        "floor": "ุงูุฃูู",
        "desc": "๐ ุงูููุชุจุฉ ูู ุงูุฏูุฑ ุงูุฃููุ ุฃูุงู ุงููุตุนุฏ ูุจุงุดุฑุฉ."
    },
    "ุงูุนูุงุฏุฉ": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ฅ ุงูุนูุงุฏุฉ ุงูุทุจูุฉ ูุฑุจ ุงููุณุฑุญุ ุจุฌุงูุจ ุงูููุฑ ุงูุฑุฆูุณู."
    },
    "ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู": {
        "floor": "ุงูุฃูู",
        "desc": "๐งญ ููุชุจ ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู ูู ุงูุฏูุฑ ุงูุฃูู."
    },
    "ุณุงุญุฉ ุงููุฏุฑุจุงุช": {
        "floor": "ุงูุซุงูู",
        "desc": "๐ฉโ๐ซ ุณุงุญุฉ ุงููุฏุฑุจุงุช ูู ุงูุฏูุฑ ุงูุซุงููุ ุชุฌูุน ูุนุธู ููุงุชุจ ุงููุฏุฑุจุงุช."
    },
    "ุจูุงุจุฉ 1": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉุ ุงููุฏุฎู ุงูุฃุณุงุณู ูููููุฉ."
    },
    "ุจูุงุจุฉ 2": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ ุจูุงุจุฉ ุงูุงุฏุงุฑุฉุ ุจุฌุงูุจ ุงูุฅุฏุงุฑุฉ ูุงููุงุนุงุช ุงูุฏุฑุงุณูุฉ."
    },
    "ุจูุงุจุฉ 3": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ฅ ุจูุงุจุฉ ุงูุนูุงุฏุฉุ ุชุคุฏู ูุจุงุดุฑุฉ ููุนูุงุฏุฉ ุงูุทุจูุฉ."
    },
    "ููุชุจ ุงูุนููุฏุฉ": {
        "floor": "ุงูุฃูู",
        "desc": "๐ ููุชุจ ุงูุนููุฏุฉ ูู ุงูุฏูุฑ ุงูุงุฑุถู ุฌุงูุจ ููุงุชุจ ุงูุงุฏุงุฑุฉ."
    }
    
}

# ============================
# ูุงุนุฏุฉ ุงูุทุฑู ุจูู ุงูุฃูุงูู
# ============================
ROUTES = {
    ("ุงููุณุฑุญ", "ุงููุงูุชูุฑูุง"): "๐ถโโ๏ธ ูู ุงููุณุฑุญ ุงุชุฌูู ูููููุง ุนุจุฑ ุงูููุฑ ุงูุฃุฑุถู ุญุชู ุชุตูู ุฅูู ุงููุงูุชูุฑูุง.",
    ("ุงููุณุฑุญ", "ููุงุชุจ ุงูุฅุฏุงุฑุฉ"): " ูู ุงููุณุฑุญ ุงุชุฌูู ููููุง ุฅูู ููุงูุฉ ุงูููุฑุ ุณุชุฌุฏูู ููุงุชุจ ุงูุฅุฏุงุฑุฉ ุนูู ููููู.",
    ("ุงููุณุฑุญ", "ุงูุนูุงุฏุฉ"): "๐ฅ ูู ุงููุณุฑุญ ุงุชุฌูู ูุจุงุดุฑุฉ ุฅูู ุงูููุฑ ุจุฌุงูุจ ุงููุณุฑุญุ ุงูุนูุงุฏุฉ ุนูู ุงููููู.",
    ("ุงููุณุฑุญ", "ุงูููุชุจุฉ"): "๐ ุงุตุนุฏู ุจุงููุตุนุฏ ูู ุงูุฏูุฑ ุงูุฃุฑุถู ุฅูู ุงูุฏูุฑ ุงูุฃููุ ุงูููุชุจุฉ ุฃูุงูู ูุจุงุดุฑุฉ.",
    ("ุงููุณุฑุญ", "ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู"): "๐งญ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุฃููุ ููุชุจ ุงูุฅุฑุดุงุฏ ุจุฌุงูุจ ูุณู A.",
    ("ุงููุณุฑุญ", "ุณุงุญุฉ ุงููุฏุฑุจุงุช"): "โฌ๏ธ ูู ุงููุณุฑุญ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุซุงููุ ุงุชุฌูู ูููู ุงูู ููุงูุฉ ุงูููุฑ ุจุชุฌุฏู ุณุงุญุฉ ุงูููุงุชุจ ุงูุงูู.",

    ("ุงููุงูุชูุฑูุง", "ุงููุณุฑุญ"): "โฌ๏ธ ูู ุงููุงูุชูุฑูุง ุงุชุฌูู ูููู ุฅูู ููุงูุฉ ุงูููุฑ ูุชุตูู ุฅูู ุงููุณุฑุญ.",
    ("ุงููุงูุชูุฑูุง", "ููุงุชุจ ุงูุฅุฏุงุฑุฉ"): "๐ข ูู ุงููุงูุชูุฑูุง ุงุชุฌูู ูุจุงุดุฑุฉ ุฅูู ููุชุจ ุงูุฅุฏุงุฑุฉ ุจุฌุงูุจ ุงูููุฑ.",
    ("ุงููุงูุชูุฑูุง", "ุงูููุชุจุฉ"): "๐ ุงุตุนุฏู ูุตุนุฏ ุงูุนูุงุฏุฉ ุฅูู ุงูุฏูุฑ ุงูุฃููุ ุงูููุชุจุฉ ุฃูุงูู ูุจุงุดุฑุฉ.",

    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ุงููุณุฑุญ"): "โก๏ธ ูู ููุชุจ ุงูุฅุฏุงุฑุฉ ุงุชุฌูู ูุณุงุฑ ููููุฑ ุงูุฃุฑุถูุ ุงููุณุฑุญ ุนูู ูุณุงุฑู.",
    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ุงููุงูุชูุฑูุง"): "โ๏ธ ุงูุดู ูุจุงุดุฑุฉ ุนุจุฑ ุงูููุฑ ุงูุฃุฑุถูุ ุงููุงูุชูุฑูุง ุงูุงูู.",
    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ุงูููุชุจุฉ"): "๐ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุฃููุ ุงูููุชุจุฉ ุฃูุงูู ูุจุงุดุฑุฉ.",
    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู"): "๐งญ ุจุนุฏ ุงููุตุนุฏ ูู ุงูุฏูุฑ ุงูุฃููุ ุณุชุฌุฏูู ููุชุจ ุงูุฅุฑุดุงุฏ ุจุฌุงูุจ ุงูููุชุจุฉ.",
    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ุณุงุญุฉ ุงููุฏุฑุจุงุช"): "โฌ๏ธ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุซุงููุ ุณุงุญุฉ ุงููุฏุฑุจุงุช ุฃูุงูู.",

    ("ุงูููุชุจุฉ", "ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู"): "๐งญ ูู ุงูููุชุจุฉ ุงุชุฌูู ูููููุงุ ููุชุจ ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู ุจุฌุงูุจ ุงูููุชุจุฉ.",
    ("ุงูููุชุจุฉ", "ุณุงุญุฉ ุงููุฏุฑุจุงุช"): "โฌ๏ธ ูู ุงูููุชุจุฉ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุซุงููุ ุณุงุญุฉ ุงููุฏุฑุจุงุช ุฃูุงูู.",
    ("ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู", "ุณุงุญุฉ ุงููุฏุฑุจุงุช"): "โฌ๏ธ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุซุงููุ ุณุงุญุฉ ุงููุฏุฑุจุงุช ุฃูุงูู.", 
    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ููุชุจ ุงูุนููุฏุฉ"): "โฌ๏ธ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุฃููุ ููุชุจ ุงูุนููุฏุฉ ุจุฌุงูุจ ููุงุชุจ ุงูุฅุฏุงุฑุฉ.",
    ("ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู", "ุงูููุชุจุฉ"): "โฌ๏ธ ูู ููุชุจ ุงูุฅุฑุดุงุฏ ุนูุฏู ุฅูู ุงูููุชุจุฉุ ุชูุน ุฃูุงูู ูุจุงุดุฑุฉ.",
    ("ุณุงุญุฉ ุงููุฏุฑุจุงุช", "ุงูููุชุจุฉ"): "โฌ๏ธ ูู ุณุงุญุฉ ุงููุฏุฑุจุงุช ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุฃููุ ุงูููุชุจุฉ ุฃูุงูู.",
    ("ุณุงุญุฉ ุงููุฏุฑุจุงุช", "ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู"): "โฌ๏ธ ูู ุณุงุญุฉ ุงููุฏุฑุจุงุช ุงุณุชุฎุฏูู ุงููุตุนุฏ ูููุฒููุ ููุชุจ ุงูุฅุฑุดุงุฏ ุนูู ุงููุณุงุฑ."
}

FLOOR_MAP = {"1": "ุงูุฏูุฑ ุงูุฃุฑุถู", "2": "ุงูุฏูุฑ ุงูุฃูู", "3": "ุงูุฏูุฑ ุงูุซุงูู"}
SECTION_MAP = {"A": "ุงููุณู ุงูุฃูู", "B": "ุงููุณู ุงูุซุงูู", "C": "ุงููุณู ุงูุซุงูุซ"}

def detect_classroom(text):
    t = str(text).upper()
    
    match = re.search(r"\b([1-3])\s*[-]?\s*([A-C])\s*[-]?\s*0*([0-9]{1,3})\b", t)
    
    if match:
        floor, sec, num = match.groups()
        floor_name = FLOOR_MAP.get(floor, floor)
        
       
        nearest_gate = "ุจูุงุจุฉ 2 (ุจูุงุจุฉ ุงูุงุฏุงุฑุฉ)"
        if sec == 'C' and floor == '1':
             nearest_gate = "ุจูุงุจุฉ 3 (ูุฑูุจุฉ ูู ูุณู C ูุงูุนูุงุฏุฉ)"
        elif sec in ['A', 'B']:
             nearest_gate = "ุจูุงุจุฉ ุงูุงุฏุงุฑุฉ"

        return (f"๐ ุชูุงุตูู ุงููุงุนุฉ:\n"
                f"- ุงูุฏูุฑ: {floor_name}\n"
                f"- ุงููุณู: {sec}\n"
                f"- ุงููุงุนุฉ: {num}\n"
                f"๐ช ุฃูุฑุจ ูุฏุฎู: {nearest_gate}.")
    return None

# ============================
# 2๏ธโฃ (ุชุงุจุน) PLACE_OPTIONS ู FAQ ูุฎุฑุงุฆุท ุงููุชุฑุงุฏูุงุช
# ============================
PLACE_OPTIONS = {
    "ููุงูู": {
        "text": "๐ ุชูุฌุฏ ููุงูู ุฃูุงููุฉ ูุฎูููุฉ. ูุถูุงู ุงุฎุชุงุฑู ุงูุฑูู:",
        "options": ["ุงูููุงูู ุงูุฃูุงููุฉ", "ุงูููุงูู ุงูุฎูููุฉ"]
    },
    "ุจูุงุจุงุช": {
        "text": "๐ช ุชูุฌุฏ 3 ุจูุงุจุงุช. ูุถูุงู ุงุฎุชุงุฑู ุงูุฑูู:",
        "options": ["ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ", "ุจูุงุจุฉ ุงูุงุฏุงุฑุฉ", "ุจูุงุจุฉ ุงูุนูุงุฏุฉ"]
    },
    "ูุทุนู ููููู": {
        "text": "โ๏ธ ุชูุฌุฏ ุงููุงูุชูุฑูุง ูุงููููู. ูุถูุงู ุงุฎุชุงุฑู ุงูุฑูู:",
        "options": ["ุงููุงูุชูุฑูุง", "ุงููููู"]
    }
}

NUMBER_TO_OPTION = {}
for key, data in PLACE_OPTIONS.items():
    NUMBER_TO_OPTION[key] = {str(i + 1): opt for i, opt in enumerate(data["options"])}

GATE_DETAILS = {
    "ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ": "๐ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ: ุงููุฏุฎู ุงูุฃุณุงุณู ูููููุฉ.",
    "ุจูุงุจุฉ ุงูุงุฏุงุฑุฉ": "๐ ุจูุงุจุฉ ุงูุงุฏุงุฑุฉ: ุฌุงูุจ ุงูุงุฏุงุฑุฉ ู ูุฑูุจ ูู ุงููุงุนุงุช ุงูุฏุฑุงุณูุฉ.",
    "ุจูุงุจุฉ ุงูุนูุงุฏุฉ": "๐ฅ ุจูุงุจุฉ ุงูุนูุงุฏุฉ: ุชุคุฏู ูุจุงุดุฑุฉ ููุนูุงุฏุฉ ุงูุทุจูุฉ."
}
PARKING_DETAILS = {
    "ุงูููุงูู ุงูุฃูุงููุฉ": "๐ ุงูููุงูู ุงูุฃูุงููุฉ: ุฃูุงู ูุจูู ุงููููุฉ.",
    "ุงูููุงูู ุงูุฎูููุฉ": "๐ ุงูููุงูู ุงูุฎูููุฉ: ุฎูู ุงููุจูู ูุจุงุดุฑุฉ."
}
CAFE_DETAILS = {
    "ุงููุงูุชูุฑูุง": "๐ฝ๏ธ ุงููุงูุชูุฑูุง: ุชูุฏู ูุฌุจุงุช ุฎูููุฉ ููุดุฑูุจุงุช. ูููุนูุง ุจุฌูุงุฑ ุงูููุชุจุฉ.",
    "ุงููููู": "โ ุงููููู: ููุฏู ูููุฉ ููุดุฑูุจุงุช ุณุงุฎูุฉ. ูููุนู ูู ุงูุฏูุฑ ุงูุฃุฑุถู."
}

ALL_DETAILS = {**GATE_DETAILS, **PARKING_DETAILS, **CAFE_DETAILS}

faq = {
    "ุชููู": "๐ ููููู ุงูุชููู ุจุณูููุฉ ุนู ุทุฑูู ุงูููุฑุงุช ุงูุฑุฆูุณูุฉ ุงููุงุณุนุฉ ูุงููุฒูุฏุฉ ุจููุญุฏุฑุงุช (Ramps)ุ ุจุงูุฅุถุงูุฉ ุฅูู ุงููุตุงุนุฏ ุงูููุฌูุฏุฉ ุนูุฏ ุฃูุณุงู A ู B ูุนูุฏ ุงูุนูุงุฏุฉ.",    "ุงูุญูุงูุงุช": "๐ป ูู ูู ูุณู ุฏุฑุงุณู (A, B, C) ุชูุฌุฏ ุฏูุฑุงุช ููุงู ูู ููุงูุฉ ุงูููุฑ. ูุชูุฌุฏ ุฃูุถูุง ุฏุงุฎู ููุทูุฉ ุงููุงูุชูุฑูุง ูุงููููู.",
    "ุงููุตุงุนุฏ": "โฌ๏ธ ุจุนุฏ ุณูุดู A ูู ูุตุนุฏุ ูุจุนุฏ ุณูุดู B ูู ูุตุนุฏ ุซุงูู. ููู ูุตุนุฏ ุนูุฏ ุงูุนูุงุฏุฉ ููุตู ููููุชุจุฉ.",
    "ุงูุนูุงุฏุฉ": "๐ฅ ุงูุนูุงุฏุฉ ุจูู ุงููุงูุชูุฑูุง ูุงููุณุฑุญ ุนูุฏ ุจูุงุจุฉ ุงูุนูุงุฏุฉ ูุจุงุดุฑุฉ.",
    "ุงููุณุฑุญ": "๐ญ ูู ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ ุงุชุฌูู ูุณุงุฑ ูุจุชูููู ุงููุณุฑุญ ุนูู ุทูู.",
    "ุงูููุชุจุฉ": "๐ ุงุณุชุฎุฏูู ุงููุตุนุฏ ุงููู ุนูุฏ ุงูุนูุงุฏุฉ ูุจุชูููู ุงูููุชุจุฉ ูุฏุงูู ูุจุงุดุฑุฉ.",
    "ูุงุนุฉ ุงูุฃุบุฑุงุถ": "๐ข ูู ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ ุงุชุฌูู ููููุ ุงููุงุนุฉ ูุฏุงูู ุนูู ุทูู.",
    "ูุงุนุฉ ูุนุงูู ุฃุญูุฏ ุงููููุฏ": "๐ ุนูุฏ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ ูู ูุตุนุฏ ูุทูุนู ูููุงุนู ูุจุงุดุฑุฉ.",
    "ุญุงุฑุณุงุช ุงูุฃูู": "๐ก ููุชุจ ุงูุญุงุฑุณุงุช ุนูุฏ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ ูุจุงุดุฑุฉ.",
    "ุงูููุชุจุฉ ุงููุงููุฉ": "๐ฐ ุจุงูุฏูุฑ ุงูุฃูู ุจุนุฏ ุณูุดู A ุงูุดู ูุฏูุงู ุดูู ุจุชูููู ุงูููุชุจูู.",
    "ุงููุฑุดุฏุฉ ุงูุทูุงุจูุฉ": "๐ง ููุณ ููุงู ุงูููุชุจุฉ ุงููุงููุฉ โ ุงูุฏูุฑ ุงูุฃูู ุจุนุฏ ุณูุดู A.",
    "ุงูุฅุฏุงุฑุฉ": "๐ข ูู ุงููุงูุชูุฑูุง ุงูุดู ูุฏูุงู ูุขุฎุฑ ุงูููุฑ ูุจุชูุตููู ููุฅุฏุงุฑุฉ. ุฃู ูู ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ ูููู ูุจุนุฏูุง ูููู.",
    "ุณุงุญุฉ ุงููุฏุฑุจุงุช": "๐ฉโ๐ซ ููู ุงูุฅุฏุงุฑุฉ ูุจุงุดุฑุฉ ูู ุงูุฏูุฑ ุงูุฃูู ูุงูุซุงูู.",
    "ุงููุงูุชูุฑูุง": "๐ฝ ุจุงูุฏูุฑ ุงูุฃุฑุถู.",
    "ุงููููู": "โ๏ธ ุจุงูุฏูุฑ ุงูุฃูู ููู ุงููุงูุชูุฑูุง.",
    "ูุณุงุนุฏุฉ":f"๐ก ูููุณุงุนุฏุฉ: ุงุถุบุทู ุงูุฒุฑ ููุชูุงุตู ุนุจุฑ ูุงุชุณุงุจ: {whatsapp_link}",
    "ููุชุจ ุงูุงุฑุดุงุฏ ุงูุงูุงุฏููู": " ุงูุฏูุฑ ุงูุงูู ุฌุงูุจ ุงูููุชุจุฉ ุงููุงููุฉ",
    "ููุชุจ ุงูุนููุฏุฉ": "ููุน ููุชุจ ุงูุนููุฏุฉ ูู ุงูููุทูุฉ ุงูุฅุฏุงุฑูุฉ ููุนุฑูุฉ ุชูุงุตูู ุงููุตูู ุงุฎุชุงุฑู ููุงุชุจ ุงูุงุฏุงุฑุฉ ",
    "ูุนุงููุงุช": "๐ข ูุชู ุงูุฅุนูุงู ุนู ุฌููุน ุงููุนุงููุงุช ูุงูุฏูุฑุงุช ูู ุงููููุฉ ุนุจุฑ ุงููููุงุช ุงูุฑุณููุฉ ุงูุชุงููุฉ:\n1. ูููุน ุงููููุฉ ุงูุฅููุชุฑููู.\n2. ุญุณุงุจุงุช ุงููููุฉ ุนูู ููุตุงุช ุงูุชูุงุตู ุงูุงุฌุชูุงุนู (ุชููุชุฑุ ุงูุณุชุฌุฑุงู).\n3. ุงูุดุงุดุงุช ุงูุฅููุชุฑูููุฉ ูููุญุงุช ุงูุฅุนูุงูุงุช ุฏุงุฎู ุงููุจูู.",
}


ALL_FAQ_KEYWORDS = {k: v for k, v in faq.items()}
for k in ALL_DETAILS:
    if k not in ALL_FAQ_KEYWORDS:
        ALL_FAQ_KEYWORDS[k] = ALL_DETAILS[k]
for k in PLACE_OPTIONS:
    if k not in ALL_FAQ_KEYWORDS:
        ALL_FAQ_KEYWORDS[k] = PLACE_OPTIONS[k]["text"]

# ... (ุซู ูุฃุชู ุจุนุฏ ุฐูู ููุทู ุงููุณุงุฑุงุช [Routing] ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ูููุฉ ููุชุงุญูุฉ ูุจุงุดุฑุฉ)
synonym_map = {
    "ุญูุงูุงุช":["ุฏูุฑุฉ ููุงู","ุญูุงู","ุฏูุฑู ููุงู" ,"ุชูุงููุช"],
    "ููุงูู": ["ูููู", "ุณูุงุฑุงุช", "ุณูุงุฑู", "ุจุงุฑูููู", "ููู ุงููู"],
    "ุจูุงุจุงุช": ["ุจูุงุจุฉ", "ุจูุงุจู", "ูุฏุฎู", "ูุฎุงุฑุฌ"],
    "ูุตุงุนุฏ": ["ูุตุนุฏ", "ุงุตุงูุตูุฑ", "ุงุณูุณูุฑ", "ุงุฑูุน"],
    "ุณุงุญุฉ ุงููุฏุฑุจุงุช": ["ูุฏุฑุจุงุช", "ููุชุจ ุงููุฏุฑุจุฉ", "ููุงุชุจ ุงูุฏูุงุชุฑุฉ"],
    "ูุณุงุนุฏุฉ": ["ูุณุงุนุฏุฉ", "ุฏุนู", "ูุดููุฉ", "ุงุจุบู ูุณุงุนุฏุฉ","ูุณุงุนุฏู","ุชูุงุตู","ุงุชูุงุตู","ุงุชูุงุตู ูุน","ุงุญุชุงุฌ","ูุณุงุนุฏูู"],
    "ุงูุนูุงุฏุฉ": ["ุงูุนูุงุฏุฉ ุงูุทุจูุฉ", "ุฏูุชูุฑุฉ", "ุงุณุนุงูุงุช"],
    "ุงูููุชุจุฉ": ["ุงูููุชุจุฉ ุงูุฑุฆูุณูุฉ", "ููุชุจุฉ", "ูุชุจ"],
    "ููุชุจ ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู": ["ุงูุฅุฑุดุงุฏ", "ุดุคูู ุงูุทูุงุจ","ููุชุจ ุงูุงุฑุดุงุฏ"],
    "ููุงุชุจ ุงูุฅุฏุงุฑุฉ": ["ุงูุงุฏุงุฑุฉ ุงูุฑุฆูุณูุฉ", "ุนูุงุฏุฉ ุงููููุฉ",],
    "ุจูุงุจุฉ 1": ["ุงูุฑุฆูุณูุฉ", "ุงููุฏุฎู ุงูุฑุฆูุณู"],
    "ุจูุงุจุฉ 2": ["ุงููุงุนุงุช", "ุจูุงุจุฉ ุงููุงุนุงุช ุงูุฏุฑุงุณูุฉ"],
    "ุจูุงุจุฉ 3": ["ุงูุนูุงุฏุฉ", "ุจูุงุจุฉ ุงูุนูุงุฏุฉ"],
    "ุงูููุงูู ุงูุฃูุงููุฉ": ["ุฃูุงููุฉ", "ุงูุงูุงู"],
    "ุงูููุงูู ุงูุฎูููุฉ": ["ุฎูููุฉ", "ุงูุฎูู"],
    "ุงููุงูุชูุฑูุง": ["ูุงูุชูุฑูุง","ููุชูุฑูุง","ุงูู"],
    "ุงููููู": ["ูููู", "ูููุฉ","ูููู"],
    "ุงููุณุฑุญ": ["ุซูุงุชุฑ", "ูุณุงุฑุญ"],
    "ุงูุฅุฏุงุฑุฉ": ["ุงูุงุฏุงุฑู", "ููุชุจ ุงูุงุฏุงุฑุฉ", "ูุจูู ุงูุฅุฏุงุฑุฉ"],
    "ุญุงุฑุณุงุช ุงูุฃูู": ["ุงูู", "ุญุฑุงุณุฉ", "ุญุงุฑุณุฉ", "ุณูููุฑุชู","ุงูุงูู","ุงูุฃูู"],
    "ุงูููุชุจุฉ ุงููุงููุฉ": ["ูุงููุฉ", "ูุงููู"],
    "ุงููุฑุดุฏุฉ ุงูุทูุงุจูุฉ": ["ูุฑุดุฏุฉ", "ูุฑุดุฏู", "ูุฑุดุฏ"],
    "ูุงุนุฉ ุงูุฃุบุฑุงุถ": ["ูุงุนุฉ ูุชุนุฏุฏุฉ", "ูุงุนุฉ ุงูุงุบุฑุงุถ", " ูุงุนุฉ ุงูุงุบุฑุงุถ ุงููุชุนุฏุฏู","ูุคุชูุฑ","ุงููุคุชูุฑ"],
    "ูุงุนุฉ ูุนุงูู ุฃุญูุฏ ุงููููุฏ": ["ุงููููุฏ", "ูุงุนุฉ ุงุญูุฏ ุงููููุฏ","ูุนุงูู"],
    "ูุนุงููุงุช": ["ูุนุงููุงุช", "ููุงุณุจุงุช", "ุฃูุดุทุฉ", "ูุดุงุท"],
    "ููุชุจ ุงูุนููุฏุฉ":["ุงูุนููุฏู","ููุชุจ ุงูุนููุฏู"],
    "ุชููู ": ["ุงูููุฑ ุงูุฃุณูู", "ุงุณูู ููุฑ", "ุงูุชููู", "ุชููู","ุทุฑูู ุงุณุฑุน"],

}



def clean_text(text):
    text = str(text).lower()
    text = text.translate(str.maketrans('', '', string.punctuation))
    text = text.replace("ุฉ", "ู").replace("ู", "ู")
    return text

def get_keyword(user_input):
    user_text = clean_text(user_input)
    tokens = user_text.split()
    for main_keyword, synonyms in synonym_map.items():
        terms = [main_keyword] + synonyms
        for t in terms:
            if clean_text(t) in user_text: # ุชุญุณูู ุงูุจุญุซ ููุดูู ุงูุฌูู
                return main_keyword
    
    all_keys_clean = {clean_text(k): k for k in ALL_FAQ_KEYWORDS.keys()}
    match = get_close_matches(user_text, list(all_keys_clean.keys()), n=1, cutoff=0.6)
    if match:
        return all_keys_clean[match[0]]
    return None

def get_welcome_message():
    hour = datetime.now().hour
    greeting = "ุตุจุงุญ ุงูุฎูุฑ ๐ธ" if hour < 12 else "ูุณุงุก ุงูุฎูุฑ ๐"
    return [{"role": "assistant", "content": f"""**{greeting}! ุฃููุงู ุจูู ูู ุฏุฑูุจ ุขููุฉ ๐**

ุฃูุง ูุฑุดุฏุชู ุงูุฐููุฉุ ููุง ููุณุงุนุฏุชู ูู ุงููุตูู ูุฃู ููุงู ุฏุงุฎู ุงููููุฉ.
ุงุณุชุฎุฏูู ุงูุฃุฒุฑุงุฑ ุจุงูุฃุณูู ๐ ุฃู ุงุณุฃูู ุนูุง ุชุจุญุซูู ุนูู."""}]

def clear_all():
    wm = get_welcome_message()
    return wm, wm, {"state": "NORMAL", "last_option_key": None}, ""

# ============================
# ููุทู ุงููุญุงุฏุซุฉ (CHAT LOGIC)
# ============================
def chat(message, history, user_session):
    try:
        history = history or get_welcome_message()
        user_session = user_session or {"state": "NORMAL", "last_option_key": None}
        user_message = str(message).strip() if message else ""

        if not user_message:
            return history, history, user_session, ""

        history.append({"role": "user", "content": user_message})

        # 1. ูุดู ุงููุงุนุงุช
        classroom_info = detect_classroom(user_message)
        if classroom_info:
            history.append({"role": "assistant", "content": classroom_info})
            return history, history, user_session, ""

        # 2. ุงูุชุนุงูู ูุน ุงูุฎูุงุฑุงุช ุงูุฑูููุฉ
        num_digits = re.sub(r"\D", "", user_message)
        if user_session.get("last_option_key") and num_digits.isdigit():
            last_key = user_session["last_option_key"]
            if last_key in NUMBER_TO_OPTION and num_digits in NUMBER_TO_OPTION[last_key]:
                chosen = NUMBER_TO_OPTION[last_key][num_digits]
                answer = ALL_DETAILS.get(chosen, "ุนุฐุฑูุงุ ูุง ุชูุฌุฏ ุชูุงุตูู.")
                user_session["last_option_key"] = None
                history.append({"role": "assistant", "content": answer})
                return history, history, user_session, ""

        # 3. ุงูุจุญุซ ุจุงููููุงุช ุงูููุชุงุญูุฉ
        keyword = get_keyword(user_message)
        
        # ุฅุฐุง ูุงู ุฎูุงุฑ ูุชุนุฏุฏ
        if keyword in PLACE_OPTIONS:
            user_session["last_option_key"] = keyword
            options_text = "\n".join([f"**{i+1}.** {opt}" for i, opt in enumerate(PLACE_OPTIONS[keyword]["options"])])
            answer = f"{PLACE_OPTIONS[keyword]['text']}\n\n{options_text}"
            history.append({"role": "assistant", "content": answer})
            return history, history, user_session, ""
            
        # ุฅุฐุง ูุงูุช ูุนูููุฉ ูุจุงุดุฑุฉ
        if keyword and keyword in ALL_FAQ_KEYWORDS:
            answer = ALL_FAQ_KEYWORDS[keyword]
            user_session["last_option_key"] = None
            history.append({"role": "assistant", "content": answer})
            return history, history, user_session, ""

        # 4. ุงุณุชุฎุฏุงู Gemini (ุฅุฐุง ูู ูุฌุฏ ุฅุฌุงุจุฉ ูุญุฏุฏุฉ)
        if GEMINI_ENABLED:
            local_context = "\n".join([f"{k}: {v}" for k, v in list(ALL_FAQ_KEYWORDS.items())[:30]])
            gemini_response = call_gemini_api(user_message, local_context_text=local_context)
            history.append({"role": "assistant", "content": f"๐ค {gemini_response}"})
        else:
            history.append({"role": "assistant", "content": "โ๏ธ ุนุฐุฑูุงุ ูู ุฃููู ุงูุณุคุงู ุฌูุฏูุงุ ูุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุบูุฑ ููุนูุฉ ุญุงููุงู."})

        return history, history, user_session, ""

    except Exception as e:
        history.append({"role": "assistant", "content": f"โ๏ธ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน: {e}"})
        return history, history, user_session, ""

# ============================
# ุชุตููู ุงููุงุฌูุฉ (THEME & UI)
# ============================

# ุชุฃูุฏู ุฃู custom_css ูุญุชูู ุนูู ูู ูุฐุง:
custom_css = """
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

.gradio-container { 
    font-family: 'Cairo', sans-serif !important; 
    /* ุฎูููุฉ ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ - ุฑูุงุฏู ุบุงูู/ุฃุณูุฏ ุฎููู */
    background-color: #383838; 
}

/* ุชูุณูู ุงูุฎูููุฉ ุงูุจูุถุงุก ุฏุงุฎู ุงููุงุฌูุฉ */
.gradio-container, .gr-box {
    background-color: #F5F5F5 !important;
}

/* ุงูุฃุฒุฑุงุฑ ุงูุฑุฆูุณูุฉ (ุงูููู ุงูุฃุณุงุณู ููุดุนุงุฑ) */
.primary-btn, button.primary {
    background-color: #1A5499 !important; /* ุฃุฒุฑู ุฏุงูู ูู ุงูุดุนุงุฑ */
    color: white !important;
    border: none !important;
    font-weight: 700 !important;
}
.primary-btn:hover, button.primary:hover {
    background-color: #123d72 !important; /* ุฃุบูู ููููุงู ุนูุฏ ุงูุชูุฑูุฑ */
}

/* ุงูุฃุฒุฑุงุฑ ุงููุฑุนูุฉ (ููู ุฃููููุฉ ุงูุดุนุงุฑ ุงููุงุชุญ) */
.secondary-btn, button.secondary {
    background-color: #E0E0E0 !important; /* ุฎูููุฉ ูุงุชุญุฉ */
    color: #1A5499 !important; /* ูุต ุฃุฒุฑู ุบุงูู */
    border: 1px solid #CCCCCC !important;
}
.secondary-btn:hover, button.secondary:hover {
    background-color: #D3D3D3 !important;
}

/* ููู ุงูุนูุงููู ูุงูุฑููุฒ (ุงูุฃุฒุฑู ุงูุบุงูู) */
h1, h2, h3, h4, .gr-label {
    color: #1A5499 !important;
}

/* ุฎูููุฉ ุญููู ุงูุฅุฏุฎุงู */
.gr-text-input, input[type="text"] {
    background-color: #FFFFFF !important;
    border: 1px solid #CCCCCC !important;
}

.start-btn { 
    font-size: 1.2em !important; 
    padding: 10px 30px !important; 
}

footer { visibility: hidden; }
"""

# --------------------------------------------------------------------
# 1. ุจุฏุงูุฉ ูุงุฌูุฉ Blocks (ุงููุณุชูู ุงูุฃูู ูู ุงูุฅุฒุงุญุฉ ูุจุฏุฃ ูู ููุง)
# --------------------------------------------------------------------
with gr.Blocks(title="ุฏุฑูุจ ุขููุฉ") as app:

    # --- ุตูุญุฉ ุงูุจุฏุงูุฉ --- (ุงูุฅุฒุงุญุฉ: 1)
    with gr.Column(visible=True, elem_id="intro_box") as intro_box:
        gr.Markdown("""
<div style="text-align:center; padding: 50px 20px;">
    <h1 style='font-size: 3em; margin-bottom: 10px;'>๐ ุฏุฑูุจ ุขููุฉ</h1>
    <h3 style='opacity: 0.8;'>ุงููููุฉ ุงูุชูููุฉ ุงูุฑูููุฉ ุจุฌุฏุฉ</h3>
    <p style="font-size: 1.1em; max-width: 600px; margin: 20px auto; line-height: 1.6;">
    ูุฑุญุจูุง ุจู ูู ุฑุญุงุจ ุงููููุฉ ุงูุชูููุฉ ุงูุฑูููุฉุ ุญูุซ ูุฏูุฌ ุงูุชูููุฉ ูุน ุงูุฅุจุฏุงุน ูุชุทููุฑ ููุงุฑุงุชู ูููุงูุจู.
            ููุง ุณุชุฌุฏูู ุจูุฆุฉ ุชุนููููุฉ ุญุฏูุซุฉุ ููุฑุงูู ูููุฃุฉ ูุฏุนู ุฌููุน ุงูุทูุงุจุ ูุน ุณูููุฉ ุงููุตูู ูุงูุชููู ุฏุงุฎู ุงููุจูู.  
            ุงุณุชูุดูู ุฎุฏูุงุชูุง ูุงุณุฃูู ุฃู ุดูุก ุนู ุงููููุฉุ ูุณุฃููู ูุฑุดุฏู ุงูุฐูู ููุฅุฌุงุจุฉ ุนู ุงุณุชูุณุงุฑุงุชู! ๐
    </p>
</div>
""")

        with gr.Row():
            with gr.Column(scale=1): pass
            with gr.Column(scale=1):
                start_btn = gr.Button("ุงุจุฏุฆู ุงูุขู ๐", variant="primary", elem_classes="start-btn")
            with gr.Column(scale=1): pass

    # --- ุตูุญุฉ ุงููุญุงุฏุซุฉ ---
    with gr.Column(visible=False) as bot_box:
        
        with gr.Row():
            gr.Markdown("### ๐ฌ ุงููุณุงุนุฏุฉ ุงูุฐููุฉ")
        
        user_session = gr.State({"state": "NORMAL", "last_option_key": None})
        chatbot_history = gr.State(get_welcome_message())
        
        chatbot = gr.Chatbot(
            value=get_welcome_message(),
            label="ุงูุฏุฑุฏุดุฉ",
            height=450,
            elem_classes="chat-window"
        )

        # ุฃุฒุฑุงุฑ ุงููุตูู ุงูุณุฑูุน
        gr.Markdown("##### โก ุฎูุงุฑุงุช ุณุฑูุนุฉ")
        with gr.Row():
            btn_parking = gr.Button("๐ ููุงูู")
            btn_gates = gr.Button("๐ช ุจูุงุจุงุช")
            btn_cafe = gr.Button("โ ูุทุนู ููููู")
            btn_clinic = gr.Button("๐ฅ ุงูุนูุงุฏุฉ")
        with gr.Row():
            btn_library = gr.Button("๐ ุงูููุชุจุฉ")
            btn_trainers = gr.Button("๐ฉโ๐ซ ุณุงุญุฉ ุงููุฏุฑุจุงุช")
            btn_help = gr.Button("โ ูุณุงุนุฏุฉ")

        # ุฎุงูุฉ ุงูุฅุฏุฎุงู
        with gr.Row():
            message = gr.Textbox(
                placeholder="ุงูุชุจู ุณุคุงูู ููุง ุฃู ุฑูู ุงููุงุนุฉ...",
                show_label=False,
                scale=4,
                lines=1
            )
            send_button = gr.Button("ุฅุฑุณุงู โค", variant="primary", scale=1)

        # ุฃุฏูุงุช ุฅุถุงููุฉ
        with gr.Row():
            clear_btn = gr.Button("๐๏ธ ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ")
            whatsapp_button = gr.Button("๐ฒ ุชูุงุตู ูุงุชุณุงุจ")

        # --- ุฑุจุท ุงูุฃุญุฏุงุซ (Events) ---
        
        def respond(msg, hist, sess):
            h, _, s, _ = chat(msg, hist, sess)
            return h, h, s, ""

        message.submit(respond, [message, chatbot_history, user_session], [chatbot, chatbot_history, user_session, message])
        send_button.click(respond, [message, chatbot_history, user_session], [chatbot, chatbot_history, user_session, message])
        
        for btn in [btn_parking, btn_gates, btn_cafe, btn_clinic, btn_library, btn_trainers, btn_help]:
            btn.click(lambda x: x, inputs=[btn], outputs=[message]).then(
                respond, [message, chatbot_history, user_session], [chatbot, chatbot_history, user_session, message]
            )

        clear_btn.click(clear_all, None, [chatbot, chatbot_history, user_session, message])
        whatsapp_button.click(launch_whatsapp_button, None, None)

        start_btn.click(
            lambda: (gr.update(visible=False), gr.update(visible=True)),
            None, [intro_box, bot_box]
        )

if __name__ == "__main__":
    app.launch(share=True, css=custom_css)
