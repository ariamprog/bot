import os
import gradio as gr
import webbrowser
import string
import re
from difflib import get_close_matches
from datetime import datetime
import google.generativeai as genai
import json

# ============================
# 1๏ธโฃ ุฅุนุฏุงุฏ Gemini API (ุขูู ุนุจุฑ env var)
# ============================
GEMINI_API_KEY = "AIzaSyBd8j6f-SoI5EtC33zJUesGufU9fk9E7O8"
# ูู ุจุฏุงูุฉ ุงูููุฏุ ุญูู ุงูุณุทุฑ 10
GEMINI_MODEL = os.getenv("GEMINI_MODEL", "gemini-1.5-flash")

GEMINI_ENABLED = False
try:
    if GEMINI_API_KEY:
        genai.configure(api_key=GEMINI_API_KEY)
        GEMINI_ENABLED = True
        print("โ Gemini client initialized successfully.")
    else:
        print("โ๏ธ GEMINI_API_KEY not found. Gemini disabled.")
        GEMINI_ENABLED = False
except Exception as e:
    print(f"โ๏ธ Failed to initialize Gemini client: {e}")
    GEMINI_ENABLED = False




def call_gemini_api(user_question, local_context_text=""):
    if not GEMINI_ENABLED:
        return "Gemini API ุบูุฑ ููุนูู."
    try:
        system_instructions = (
            "ุฃูุช ูุณุงุนุฏ ูุฑุดุฏ ูููููุฉ ุงูุชูููุฉ ุงูุฑูููุฉ ุจุฌุฏุฉ. "
            "ุฃุฌูุจู ุจุงุฎุชุตุงุฑ ูุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู ุงููุจุณุทุฉ. "
            "ุงุนุชูุฏู ุฃููุงู ุนูู ุงููุนูููุงุช ุงููุญููุฉ ุงููุฏุฑุฌุฉ (LOCAL_CONTEXT). "
            "ุฅุฐุง ูุงูุช ุงูุฅุฌุงุจุฉ ููุฌูุฏุฉ ูููุง ุงุณุชุฎุฑุฌููุง ุญุฑูููุง. "
            "ุฅุฐุง ูู ุชูู ุงูุฅุฌุงุจุฉ ููุฌูุฏุฉุ ุงุนุชุฑูู ุจุนุฏู ุงููุนุฑูุฉ ุจูุทู ููุฌูู ุงููุณุชุฎุฏู ุฅูู ุทุฑู ุงูุญุตูู ุนูู ุงููุนูููุฉ. "
            "ุชุฌูุจู ุงูุชุฎููู ูุงููููุณุฉ. ุฅุฌุงุจุงุช ูุตูุฑุฉ ููุจุงุดุฑุฉ."
        )

        prompt = f"{system_instructions}\n\nLOCAL_CONTEXT:\n{local_context_text}\n\nุงูุณุคุงู:\n{user_question}\n\nุงูุฑุฏ:"
        
        model = genai.GenerativeModel(GEMINI_MODEL)
        
        # ุงูุชุตุญูุญ ููุง: ุงุณุชุฎุฏุงู GenerationConfig
        generation_config = genai.types.GenerationConfig(
            temperature=0.2,
            max_output_tokens=400
        )
        
        response = model.generate_content(prompt, generation_config=generation_config)

        if hasattr(response, "text") and response.text:
            return response.text.strip()
        # ุงูุชุนุงูู ูุน ุงูุญุงูุงุช ุงูุฃุฎุฑู ููุฑุฏ
        if hasattr(response, "candidates") and response.candidates:
            cand = response.candidates[0]
            if hasattr(cand, "content") and hasattr(cand.content, "parts"):
                 parts = [p.text for p in cand.content.parts if p.text]
                 return " ".join(parts).strip()
                 
        return "โ๏ธ ูู ุฃุญุตู ุนูู ุฅุฌุงุจุฉ ููุงุณุจุฉ ูู Gemini."
    except Exception as e:
        return f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุฏุนุงุก Gemini: {e}" 

# ุฑุงุจุท ูุงุชุณุงุจ
whatsapp_link = "https://wa.me/qr/YQ5U5MAW36FAP1"
def launch_whatsapp_button():
    webbrowser.open_new_tab(whatsapp_link)
    return None

# ============================
# 2๏ธโฃ ุจูุงูุงุช ุงููุดุฑูุน
# ============================
PLACES = {
    "ุงููุณุฑุญ": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ญ ุงููุณุฑุญ ูู ุงูุฏูุฑ ุงูุฃุฑุถู ูุฑุจ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉุ ุนูู ูุณุงุฑู ุนูุฏ ุงูุฏุฎูู."
    },
    "ุงููุงูุชูุฑูุง": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "โ๏ธ ุงููุงูุชูุฑูุง ูู ุงูุฏูุฑ ุงูุฃุฑุถู ุจุฌุงูุจ ุงูุณูุงูู ุฌุงูุจ ูุณู C ."
    },
    "ููุงุชุจ ุงูุฅุฏุงุฑุฉ": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ข   ููุงุชุจ ุงูุฅุฏุงุฑุฉ ุนูุฏ ูุฏุฎู ุงููููุฉุ ูุจุงุดุฑุฉ ุจุนุฏ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ."
    },
    "ุงูููุชุจุฉ": {
        "floor": "ุงูุฃูู",
        "desc": "๐ ุงูููุชุจุฉ ูู ุงูุฏูุฑ ุงูุฃููุ ุฃูุงู ุงููุตุนุฏ ูุจุงุดุฑุฉ."
    },
    "ุงูุนูุงุฏุฉ": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ฅ ุงูุนูุงุฏุฉ ุงูุทุจูุฉ ูุฑุจ ุงููุณุฑุญุ ุจุฌุงูุจ ุงูููุฑ ุงูุฑุฆูุณู."
    },
    "ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู": {
        "floor": "ุงูุฃูู",
        "desc": "๐งญ ููุชุจ ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู ูู ุงูุฏูุฑ ุงูุฃูู."
    },
    "ุณุงุญุฉ ุงููุฏุฑุจุงุช": {
        "floor": "ุงูุซุงูู",
        "desc": "๐ฉโ๐ซ ุณุงุญุฉ ุงููุฏุฑุจุงุช ูู ุงูุฏูุฑ ุงูุซุงููุ ุชุฌูุน ูุนุธู ููุงุชุจ ุงููุฏุฑุจุงุช."
    },
    "ุจูุงุจุฉ 1": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉุ ุงููุฏุฎู ุงูุฃุณุงุณู ูููููุฉ."
    },
    "ุจูุงุจุฉ 2": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ ุจูุงุจุฉ ุงูุงุฏุงุฑุฉุ ุจุฌุงูุจ ุงูุฅุฏุงุฑุฉ ูุงููุงุนุงุช ุงูุฏุฑุงุณูุฉ."
    },
    "ุจูุงุจุฉ 3": {
        "floor": "ุงูุฃุฑุถู",
        "desc": "๐ฅ ุจูุงุจุฉ ุงูุนูุงุฏุฉุ ุชุคุฏู ูุจุงุดุฑุฉ ููุนูุงุฏุฉ ุงูุทุจูุฉ."
    },
    "ููุชุจ ุงูุนููุฏุฉ": {
        "floor": "ุงูุฃูู",
        "desc": "๐ ููุชุจ ุงูุนููุฏุฉ ูู ุงูุฏูุฑ ุงูุงุฑุถู ุฌุงูุจ ููุงุชุจ ุงูุงุฏุงุฑุฉ."
    }
    
}

# ============================
# ูุงุนุฏุฉ ุงูุทุฑู ุจูู ุงูุฃูุงูู
# ============================
ROUTES = {
    ("ุงููุณุฑุญ", "ุงููุงูุชูุฑูุง"): "๐ถโโ๏ธ ูู ุงููุณุฑุญ ุงุชุฌูู ูููููุง ุนุจุฑ ุงูููุฑ ุงูุฃุฑุถู ุญุชู ุชุตูู ุฅูู ุงููุงูุชูุฑูุง.",
    ("ุงููุณุฑุญ", "ููุงุชุจ ุงูุฅุฏุงุฑุฉ"): " ูู ุงููุณุฑุญ ุงุชุฌูู ููููุง ุฅูู ููุงูุฉ ุงูููุฑุ ุณุชุฌุฏูู ููุงุชุจ ุงูุฅุฏุงุฑุฉ ุนูู ููููู.",
    ("ุงููุณุฑุญ", "ุงูุนูุงุฏุฉ"): "๐ฅ ูู ุงููุณุฑุญ ุงุชุฌูู ูุจุงุดุฑุฉ ุฅูู ุงูููุฑ ุจุฌุงูุจ ุงููุณุฑุญุ ุงูุนูุงุฏุฉ ุนูู ุงููููู.",
    ("ุงููุณุฑุญ", "ุงูููุชุจุฉ"): "๐ ุงุตุนุฏู ุจุงููุตุนุฏ ูู ุงูุฏูุฑ ุงูุฃุฑุถู ุฅูู ุงูุฏูุฑ ุงูุฃููุ ุงูููุชุจุฉ ุฃูุงูู ูุจุงุดุฑุฉ.",
    ("ุงููุณุฑุญ", "ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู"): "๐งญ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุฃููุ ููุชุจ ุงูุฅุฑุดุงุฏ ุจุฌุงูุจ ูุณู A.",
    ("ุงููุณุฑุญ", "ุณุงุญุฉ ุงููุฏุฑุจุงุช"): "โฌ๏ธ ูู ุงููุณุฑุญ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุซุงููุ ุงุชุฌูู ูููู ุงูู ููุงูุฉ ุงูููุฑ ุจุชุฌุฏู ุณุงุญุฉ ุงูููุงุชุจ ุงูุงูู.",

    ("ุงููุงูุชูุฑูุง", "ุงููุณุฑุญ"): "โฌ๏ธ ูู ุงููุงูุชูุฑูุง ุงุชุฌูู ูููู ุฅูู ููุงูุฉ ุงูููุฑ ูุชุตูู ุฅูู ุงููุณุฑุญ.",
    ("ุงููุงูุชูุฑูุง", "ููุงุชุจ ุงูุฅุฏุงุฑุฉ"): "๐ข ูู ุงููุงูุชูุฑูุง ุงุชุฌูู ูุจุงุดุฑุฉ ุฅูู ููุชุจ ุงูุฅุฏุงุฑุฉ ุจุฌุงูุจ ุงูููุฑ.",
    ("ุงููุงูุชูุฑูุง", "ุงูููุชุจุฉ"): "๐ ุงุตุนุฏู ูุตุนุฏ ุงูุนูุงุฏุฉ ุฅูู ุงูุฏูุฑ ุงูุฃููุ ุงูููุชุจุฉ ุฃูุงูู ูุจุงุดุฑุฉ.",

    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ุงููุณุฑุญ"): "โก๏ธ ูู ููุชุจ ุงูุฅุฏุงุฑุฉ ุงุชุฌูู ูุณุงุฑ ููููุฑ ุงูุฃุฑุถูุ ุงููุณุฑุญ ุนูู ูุณุงุฑู.",
    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ุงููุงูุชูุฑูุง"): "โ๏ธ ุงูุดู ูุจุงุดุฑุฉ ุนุจุฑ ุงูููุฑ ุงูุฃุฑุถูุ ุงููุงูุชูุฑูุง ุงูุงูู.",
    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ุงูููุชุจุฉ"): "๐ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุฃููุ ุงูููุชุจุฉ ุฃูุงูู ูุจุงุดุฑุฉ.",
    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู"): "๐งญ ุจุนุฏ ุงููุตุนุฏ ูู ุงูุฏูุฑ ุงูุฃููุ ุณุชุฌุฏูู ููุชุจ ุงูุฅุฑุดุงุฏ ุจุฌุงูุจ ุงูููุชุจุฉ.",
    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ุณุงุญุฉ ุงููุฏุฑุจุงุช"): "โฌ๏ธ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุซุงููุ ุณุงุญุฉ ุงููุฏุฑุจุงุช ุฃูุงูู.",

    ("ุงูููุชุจุฉ", "ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู"): "๐งญ ูู ุงูููุชุจุฉ ุงุชุฌูู ูููููุงุ ููุชุจ ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู ุจุฌุงูุจ ุงูููุชุจุฉ.",
    ("ุงูููุชุจุฉ", "ุณุงุญุฉ ุงููุฏุฑุจุงุช"): "โฌ๏ธ ูู ุงูููุชุจุฉ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุซุงููุ ุณุงุญุฉ ุงููุฏุฑุจุงุช ุฃูุงูู.",
    ("ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู", "ุณุงุญุฉ ุงููุฏุฑุจุงุช"): "โฌ๏ธ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุซุงููุ ุณุงุญุฉ ุงููุฏุฑุจุงุช ุฃูุงูู.", 
    # ... (ุงููุณุงุฑุงุช ุงูููุฌูุฏุฉ)
    ("ููุงุชุจ ุงูุฅุฏุงุฑุฉ", "ููุชุจ ุงูุนููุฏุฉ"): "โฌ๏ธ ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุฃููุ ููุชุจ ุงูุนููุฏุฉ ุจุฌุงูุจ ููุงุชุจ ุงูุฅุฏุงุฑุฉ.",

    # ุทุฑู ุนูุณูุฉ
    ("ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู", "ุงูููุชุจุฉ"): "โฌ๏ธ ูู ููุชุจ ุงูุฅุฑุดุงุฏ ุนูุฏู ุฅูู ุงูููุชุจุฉุ ุชูุน ุฃูุงูู ูุจุงุดุฑุฉ.",
    ("ุณุงุญุฉ ุงููุฏุฑุจุงุช", "ุงูููุชุจุฉ"): "โฌ๏ธ ูู ุณุงุญุฉ ุงููุฏุฑุจุงุช ุงุตุนุฏู ุงููุตุนุฏ ุฅูู ุงูุฏูุฑ ุงูุฃููุ ุงูููุชุจุฉ ุฃูุงูู.",
    ("ุณุงุญุฉ ุงููุฏุฑุจุงุช", "ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู"): "โฌ๏ธ ูู ุณุงุญุฉ ุงููุฏุฑุจุงุช ุงุณุชุฎุฏูู ุงููุตุนุฏ ูููุฒููุ ููุชุจ ุงูุฅุฑุดุงุฏ ุนูู ุงููุณุงุฑ."
}

FLOOR_MAP = {"1": "ุงูุฏูุฑ ุงูุฃุฑุถู", "2": "ุงูุฏูุฑ ุงูุฃูู", "3": "ุงูุฏูุฑ ุงูุซุงูู"}
SECTION_MAP = {"A": "ุงููุณู ุงูุฃูู", "B": "ุงููุณู ุงูุซุงูู", "C": "ุงููุณู ุงูุซุงูุซ"}

def detect_classroom(text):
    t = str(text).upper()
    # ุชุญุณูู ูุงูุชูุงุท ุงูุตูุบ ุงููุฎุชููุฉ ูุซู 1C3 ุฃู 1-C-3
    match = re.search(r"\b([1-3])\s*[-_]?\s*([A-C])\s*[-_]?\s*0*([0-9]{1,3})\b", t)
    
    if match:
        floor, sec, num = match.groups()
        floor_name = FLOOR_MAP.get(floor, floor)
        
        # ููุทู ุชุญุฏูุฏ ุฃูุฑุจ ุจูุงุจุฉ
        nearest_gate = "ุจูุงุจุฉ 2 (ุจูุงุจุฉ ุงูุงุฏุงุฑุฉ)"  # ุงูุงูุชุฑุงุถู ููุนุธู ุงููุงุนุงุช
        if sec == 'C' and floor == '1':
             nearest_gate = "ุจูุงุจุฉ 3 (ูุฑูุจุฉ ูู ูุณู C ูุงูุนูุงุฏุฉ)"
        elif sec in ['A', 'B']:
             nearest_gate = "ุจูุงุจุฉ ุงูุงุฏุงุฑุฉ"

        return (f"๐ *ุชูุงุตูู ุงููุงุนุฉ:*\n"
                f"- ุงูุฏูุฑ: {floor_name}\n"
                f"- ุงููุณู: {sec}\n"
                f"- ุงููุงุนุฉ: {num}\n"
                f"๐ช *ุฃูุฑุจ ูุฏุฎู:* {nearest_gate}.")
    return None

# ============================
# 2๏ธโฃ (ุชุงุจุน) PLACE_OPTIONS ู FAQ ูุฎุฑุงุฆุท ุงููุชุฑุงุฏูุงุช
# ============================
PLACE_OPTIONS = {
    "ููุงูู": {
        "text": "๐ ุชูุฌุฏ ููุงูู ุฃูุงููุฉ ูุฎูููุฉ. ูุถูุงู ุงุฎุชุงุฑู ุงูุฑูู:",
        "options": ["ุงูููุงูู ุงูุฃูุงููุฉ", "ุงูููุงูู ุงูุฎูููุฉ"]
    },
    "ุจูุงุจุงุช": {
        "text": "๐ช ุชูุฌุฏ 3 ุจูุงุจุงุช. ูุถูุงู ุงุฎุชุงุฑู ุงูุฑูู:",
        "options": ["ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ", "ุจูุงุจุฉ ุงูุงุฏุงุฑุฉ", "ุจูุงุจุฉ ุงูุนูุงุฏุฉ"]
    },
    "ูุทุนู ููููู": {
        "text": "โ๏ธ ุชูุฌุฏ ุงููุงูุชูุฑูุง ูุงููููู. ูุถูุงู ุงุฎุชุงุฑู ุงูุฑูู:",
        "options": ["ุงููุงูุชูุฑูุง", "ุงููููู"]
    }
}

NUMBER_TO_OPTION = {}
for key, data in PLACE_OPTIONS.items():
    NUMBER_TO_OPTION[key] = {str(i + 1): opt for i, opt in enumerate(data["options"])}

GATE_DETAILS = {
    "ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ": "๐ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ: ุงููุฏุฎู ุงูุฃุณุงุณู ูููููุฉ.",
    "ุจูุงุจุฉ ุงูุงุฏุงุฑุฉ": "๐ ุจูุงุจุฉ ุงูุงุฏุงุฑุฉ: ุฌุงูุจ ุงูุงุฏุงุฑุฉ ู ูุฑูุจ ูู ุงููุงุนุงุช ุงูุฏุฑุงุณูุฉ.",
    "ุจูุงุจุฉ ุงูุนูุงุฏุฉ": "๐ฅ ุจูุงุจุฉ ุงูุนูุงุฏุฉ: ุชุคุฏู ูุจุงุดุฑุฉ ููุนูุงุฏุฉ ุงูุทุจูุฉ."
}
PARKING_DETAILS = {
    "ุงูููุงูู ุงูุฃูุงููุฉ": "๐ ุงูููุงูู ุงูุฃูุงููุฉ: ุฃูุงู ูุจูู ุงููููุฉ.",
    "ุงูููุงูู ุงูุฎูููุฉ": "๐ ุงูููุงูู ุงูุฎูููุฉ: ุฎูู ุงููุจูู ูุจุงุดุฑุฉ."
}
CAFE_DETAILS = {
    "ุงููุงูุชูุฑูุง": "๐ฝ๏ธ ุงููุงูุชูุฑูุง: ุชูุฏู ูุฌุจุงุช ุฎูููุฉ ููุดุฑูุจุงุช. ูููุนูุง ุจุฌูุงุฑ ุงูููุชุจุฉ.",
    "ุงููููู": "โ ุงููููู: ููุฏู ูููุฉ ููุดุฑูุจุงุช ุณุงุฎูุฉ. ูููุนู ูู ุงูุฏูุฑ ุงูุฃุฑุถู."
}

ALL_DETAILS = {**GATE_DETAILS, **PARKING_DETAILS, **CAFE_DETAILS}

faq = {
    "ุชููู": "๐ ููููู ุงูุชููู ุจุณูููุฉ ุนู ุทุฑูู ุงูููุฑุงุช ุงูุฑุฆูุณูุฉ ุงููุงุณุนุฉ ูุงููุฒูุฏุฉ ุจููุญุฏุฑุงุช (Ramps)ุ ุจุงูุฅุถุงูุฉ ุฅูู ุงููุตุงุนุฏ ุงูููุฌูุฏุฉ ุนูุฏ ุฃูุณุงู A ู B ูุนูุฏ ุงูุนูุงุฏุฉ.",    "ุงูุญูุงูุงุช": "๐ป ูู ูู ูุณู ุฏุฑุงุณู (A, B, C) ุชูุฌุฏ ุฏูุฑุงุช ููุงู ูู ููุงูุฉ ุงูููุฑ. ูุชูุฌุฏ ุฃูุถูุง ุฏุงุฎู ููุทูุฉ ุงููุงูุชูุฑูุง ูุงููููู.",
    "ุงููุตุงุนุฏ": "โฌ๏ธ ุจุนุฏ ุณูุดู A ูู ูุตุนุฏุ ูุจุนุฏ ุณูุดู B ูู ูุตุนุฏ ุซุงูู. ููู ูุตุนุฏ ุนูุฏ ุงูุนูุงุฏุฉ ููุตู ููููุชุจุฉ.",
    "ุงูุนูุงุฏุฉ": "๐ฅ ุงูุนูุงุฏุฉ ุจูู ุงููุงูุชูุฑูุง ูุงููุณุฑุญ ุนูุฏ ุจูุงุจุฉ ุงูุนูุงุฏุฉ ูุจุงุดุฑุฉ.",
    "ุงููุณุฑุญ": "๐ญ ูู ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ ุงุชุฌูู ูุณุงุฑ ูุจุชูููู ุงููุณุฑุญ ุนูู ุทูู.",
    "ุงูููุชุจุฉ": "๐ ุงุณุชุฎุฏูู ุงููุตุนุฏ ุงููู ุนูุฏ ุงูุนูุงุฏุฉ ูุจุชูููู ุงูููุชุจุฉ ูุฏุงูู ูุจุงุดุฑุฉ.",
    "ูุงุนุฉ ุงูุฃุบุฑุงุถ": "๐ข ูู ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ ุงุชุฌูู ููููุ ุงููุงุนุฉ ูุฏุงูู ุนูู ุทูู.",
    "ูุงุนุฉ ูุนุงูู ุฃุญูุฏ ุงููููุฏ": "๐ ุนูุฏ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ ูู ูุตุนุฏ ูุทูุนู ูููุงุนู ูุจุงุดุฑุฉ.",
    "ุญุงุฑุณุงุช ุงูุฃูู": "๐ก ููุชุจ ุงูุญุงุฑุณุงุช ุนูุฏ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ ูุจุงุดุฑุฉ.",
    "ุงูููุชุจุฉ ุงููุงููุฉ": "๐ฐ ุจุงูุฏูุฑ ุงูุฃูู ุจุนุฏ ุณูุดู A ุงูุดู ูุฏูุงู ุดูู ุจุชูููู ุงูููุชุจูู.",
    "ุงููุฑุดุฏุฉ ุงูุทูุงุจูุฉ": "๐ง ููุณ ููุงู ุงูููุชุจุฉ ุงููุงููุฉ โ ุงูุฏูุฑ ุงูุฃูู ุจุนุฏ ุณูุดู A.",
    "ุงูุฅุฏุงุฑุฉ": "๐ข ูู ุงููุงูุชูุฑูุง ุงูุดู ูุฏูุงู ูุขุฎุฑ ุงูููุฑ ูุจุชูุตููู ููุฅุฏุงุฑุฉ. ุฃู ูู ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ ูููู ูุจุนุฏูุง ูููู.",
    "ุณุงุญุฉ ุงููุฏุฑุจุงุช": "๐ฉโ๐ซ ููู ุงูุฅุฏุงุฑุฉ ูุจุงุดุฑุฉ ูู ุงูุฏูุฑ ุงูุฃูู ูุงูุซุงูู.",
    "ุงููุงูุชูุฑูุง": "๐ฝ ุจุงูุฏูุฑ ุงูุฃุฑุถู.",
    "ุงููููู": "โ๏ธ ุจุงูุฏูุฑ ุงูุฃูู ููู ุงููุงูุชูุฑูุง.",
    "ูุณุงุนุฏุฉ":f"๐ก ูููุณุงุนุฏุฉ: ุงุถุบุทู ุงูุฒุฑ ููุชูุงุตู ุนุจุฑ ูุงุชุณุงุจ: {whatsapp_link}",
    "ููุชุจ ุงูุงุฑุดุงุฏ ุงูุงูุงุฏููู": " ุงูุฏูุฑ ุงูุงูู ุฌุงูุจ ุงูููุชุจุฉ ุงููุงููุฉ",
    "ููุชุจ ุงูุนููุฏุฉ": "ููุน ููุชุจ ุงูุนููุฏุฉ ูู ุงูููุทูุฉ ุงูุฅุฏุงุฑูุฉ ููุนุฑูุฉ ุชูุงุตูู ุงููุตูู ุงุฎุชุงุฑู ููุงุชุจ ุงูุงุฏุงุฑุฉ ",
    "ูุนุงููุงุช": "๐ข ูุชู ุงูุฅุนูุงู ุนู ุฌููุน ุงููุนุงููุงุช ูุงูุฏูุฑุงุช ูู ุงููููุฉ ุนุจุฑ ุงููููุงุช ุงูุฑุณููุฉ ุงูุชุงููุฉ:\n1. ูููุน ุงููููุฉ ุงูุฅููุชุฑููู.\n2. ุญุณุงุจุงุช ุงููููุฉ ุนูู ููุตุงุช ุงูุชูุงุตู ุงูุงุฌุชูุงุนู (ุชููุชุฑุ ุงูุณุชุฌุฑุงู).\n3. ุงูุดุงุดุงุช ุงูุฅููุชุฑูููุฉ ูููุญุงุช ุงูุฅุนูุงูุงุช ุฏุงุฎู ุงููุจูู.",
}


ALL_FAQ_KEYWORDS = {k: v for k, v in faq.items()}
for k in ALL_DETAILS:
    if k not in ALL_FAQ_KEYWORDS:
        ALL_FAQ_KEYWORDS[k] = ALL_DETAILS[k]
for k in PLACE_OPTIONS:
    if k not in ALL_FAQ_KEYWORDS:
        ALL_FAQ_KEYWORDS[k] = PLACE_OPTIONS[k]["text"]

# ... (ุซู ูุฃุชู ุจุนุฏ ุฐูู ููุทู ุงููุณุงุฑุงุช [Routing] ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ูููุฉ ููุชุงุญูุฉ ูุจุงุดุฑุฉ)
synonym_map = {
    "ุญูุงูุงุช":["ุฏูุฑุฉ ููุงู","ุญูุงู","ุฏูุฑู ููุงู" ,"ุชูุงููุช"],
    "ููุงูู": ["ูููู", "ุณูุงุฑุงุช", "ุณูุงุฑู", "ุจุงุฑูููู", "ููู ุงููู"],
    "ุจูุงุจุงุช": ["ุจูุงุจุฉ", "ุจูุงุจู", "ูุฏุฎู", "ูุฎุงุฑุฌ"],
    "ูุตุงุนุฏ": ["ูุตุนุฏ", "ุงุตุงูุตูุฑ", "ุงุณูุณูุฑ", "ุงุฑูุน"],
    "ุณุงุญุฉ ุงููุฏุฑุจุงุช": ["ูุฏุฑุจุงุช", "ููุชุจ ุงููุฏุฑุจุฉ", "ููุงุชุจ ุงูุฏูุงุชุฑุฉ"],
    "ูุณุงุนุฏุฉ": ["ูุณุงุนุฏุฉ", "ุฏุนู", "ูุดููุฉ", "ุงุจุบู ูุณุงุนุฏุฉ","ูุณุงุนุฏู","ุชูุงุตู","ุงุชูุงุตู","ุงุชูุงุตู ูุน","ุงุญุชุงุฌ","ูุณุงุนุฏูู"],
    "ุงูุนูุงุฏุฉ": ["ุงูุนูุงุฏุฉ ุงูุทุจูุฉ", "ุฏูุชูุฑุฉ", "ุงุณุนุงูุงุช"],
    "ุงูููุชุจุฉ": ["ุงูููุชุจุฉ ุงูุฑุฆูุณูุฉ", "ููุชุจุฉ", "ูุชุจ"],
    "ููุชุจ ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู": ["ุงูุฅุฑุดุงุฏ", "ุดุคูู ุงูุทูุงุจ","ููุชุจ ุงูุงุฑุดุงุฏ"],
    "ููุงุชุจ ุงูุฅุฏุงุฑุฉ": ["ุงูุงุฏุงุฑุฉ ุงูุฑุฆูุณูุฉ", "ุนูุงุฏุฉ ุงููููุฉ",],
    "ุจูุงุจุฉ 1": ["ุงูุฑุฆูุณูุฉ", "ุงููุฏุฎู ุงูุฑุฆูุณู"],
    "ุจูุงุจุฉ 2": ["ุงููุงุนุงุช", "ุจูุงุจุฉ ุงููุงุนุงุช ุงูุฏุฑุงุณูุฉ"],
    "ุจูุงุจุฉ 3": ["ุงูุนูุงุฏุฉ", "ุจูุงุจุฉ ุงูุนูุงุฏุฉ"],
    "ุงูููุงูู ุงูุฃูุงููุฉ": ["ุฃูุงููุฉ", "ุงูุงูุงู"],
    "ุงูููุงูู ุงูุฎูููุฉ": ["ุฎูููุฉ", "ุงูุฎูู"],
    "ุงููุงูุชูุฑูุง": ["ูุงูุชูุฑูุง","ููุชูุฑูุง","ุงูู"],
    "ุงููููู": ["ูููู", "ูููุฉ","ูููู"],
    "ุงููุณุฑุญ": ["ุซูุงุชุฑ", "ูุณุงุฑุญ"],
    "ุงูุฅุฏุงุฑุฉ": ["ุงูุงุฏุงุฑู", "ููุชุจ ุงูุงุฏุงุฑุฉ", "ูุจูู ุงูุฅุฏุงุฑุฉ"],
    "ุญุงุฑุณุงุช ุงูุฃูู": ["ุงูู", "ุญุฑุงุณุฉ", "ุญุงุฑุณุฉ", "ุณูููุฑุชู","ุงูุงูู","ุงูุฃูู"],
    "ุงูููุชุจุฉ ุงููุงููุฉ": ["ูุงููุฉ", "ูุงููู"],
    "ุงููุฑุดุฏุฉ ุงูุทูุงุจูุฉ": ["ูุฑุดุฏุฉ", "ูุฑุดุฏู", "ูุฑุดุฏ"],
    "ูุงุนุฉ ุงูุฃุบุฑุงุถ": ["ูุงุนุฉ ูุชุนุฏุฏุฉ", "ูุงุนุฉ ุงูุงุบุฑุงุถ", " ูุงุนุฉ ุงูุงุบุฑุงุถ ุงููุชุนุฏุฏู","ูุคุชูุฑ","ุงููุคุชูุฑ"],
    "ูุงุนุฉ ูุนุงูู ุฃุญูุฏ ุงููููุฏ": ["ุงููููุฏ", "ูุงุนุฉ ุงุญูุฏ ุงููููุฏ","ูุนุงูู"],
    "ูุนุงููุงุช": ["ูุนุงููุงุช", "ููุงุณุจุงุช", "ุฃูุดุทุฉ", "ูุดุงุท"],
    "ููุชุจ ุงูุนููุฏุฉ":["ุงูุนููุฏู","ููุชุจ ุงูุนููุฏู"],
    "ุชููู ": ["ุงูููุฑ ุงูุฃุณูู", "ุงุณูู ููุฑ", "ุงูุชููู", "ุชููู","ุทุฑูู ุงุณุฑุน"],

}

# ============================
# ุฏูุงู ูุณุงุนุฏุฉ
# ============================
def clean_text(text):
    """
    ุชูุธูู ุงููุต ูุชุณููู ุงูููุงุฑูุฉ:
    - ุชุญููู ูู ุงูุญุฑูู ุฅูู ุตุบูุฑุฉ
    - ุฅุฒุงูุฉ ุงูุชุดููู
    - ุชุญููู 'ุฉ' ุฅูู 'ู'
    - ุฅุฒุงูุฉ ุนูุงูุงุช ุงูุชุฑููู
    """
    text = str(text).lower()
    text = text.translate(str.maketrans('', '', string.punctuation))
    text = text.replace("ุฉ", "ู").replace("ู", "ู")
    return text

def get_keyword(user_input):
    """
    ุงูุจุญุซ ุนู ุงููููุฉ ุงูููุชุงุญูุฉ ุงูุฃูุฑุจ ูุน ุงูุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ:
    - ุฃููุงู ูุญุงูู ุงูุจุญุซ ุจูู ุงููุฑุงุฏูุงุช
    - ุฅุฐุง ูู ูุฌุฏุ ูุณุชุฎุฏู get_close_matches ูุน cutoff ููุฎูุถ ูุณุจููุง
    """
    user_text = clean_text(user_input)
    tokens = user_text.split()

    # ุชุญูู ูู ุงููุฑุงุฏูุงุช ุฃููุงู
    for main_keyword, synonyms in synonym_map.items():
        terms = [main_keyword] + synonyms
        for t in terms:
            t_clean = clean_text(t)
            if any(t_clean == clean_text(tok) for tok in tokens):
                return main_keyword

    # ุงุณุชุฎุฏุงู get_close_matches ููุจุญุซ ุนู ุฃูุฑุจ ูููุฉ ุฑุฆูุณูุฉ
    all_keys = list(ALL_FAQ_KEYWORDS.keys())
    # ุชูุธูู ุฌููุน ุงูููุงุชูุญ ุจููุณ ุทุฑููุฉ clean_text
    all_keys_clean = {clean_text(k): k for k in all_keys}
    match = get_close_matches(user_text, list(all_keys_clean.keys()), n=1, cutoff=0.6)
    if match:
        return all_keys_clean[match[0]]
    
    return None
def get_welcome_message():
    hour = datetime.now().hour
    greeting = "ุตุจุงุญ ุงูุฎูุฑ ๐ธ" if hour < 12 else "ูุณุงุก ุงูุฎูุฑ ๐"
    return [{"role": "assistant", "content": f"""{greeting}! ุฃููุงู ุจูู ูู ุฏุฑูุจ ุขููุฉ ๐  
ุฃูุง ูุฑุดุฏุชู ุงูุขููุฉุ ุฃุณุงุนุฏู ูู ุงูุชููู ุฏุงุฎู ุงููููุฉ ุจุณูููุฉ ููุณุฑ ๐  
ุงุณุฃูู ุฃู ุณุคุงู ุฃู ุงุฎุชุงุฑู ูู ุงูุฃุฒุฑุงุฑ ุจุงูุฃุณูู ๐"""}]

def format_answer_with_images(answer_text):
    return re.sub(r'\[ุตูุฑุฉ: ([\w_]+)\]', ' (ููุฌุฏ ููุง ุชูุถูุญ ุจุงูุตูุฑุฉ)', answer_text)

def clear_all():
    welcome_message = get_welcome_message()
    return welcome_message, welcome_message, {"state": "NORMAL", "last_option_key": None, "current_location": None}, ""

# ============================
# ุฏุงูุฉ chat
# ============================
def chat(message, history, user_session):
    try:
        history = history or get_welcome_message()
        user_session = user_session or {"state": "NORMAL", "last_option_key": None}
        user_message = str(message).strip() if message else ""

        if not user_message:
            return history, history, user_session, ""

        history.append({"role": "user", "content": user_message})

        # 1. ุงูุฃููููุฉ ูููุงุนุงุช (ุชู ุชุญุฏูุซ ุงูุฏุงูุฉ ูุชุนุทู ุงูุจูุงุจุฉ)
        classroom_info = detect_classroom(user_message)
        if classroom_info:
            history.append({"role": "assistant", "content": classroom_info})
            return history, history, user_session, ""

        # 2. ุงูุฎูุงุฑุงุช ุงูุฑูููุฉ
        num_digits = re.sub(r"\D", "", user_message)
        if user_session.get("last_option_key") and num_digits.isdigit():
            last_key = user_session["last_option_key"]
            if last_key in NUMBER_TO_OPTION and num_digits in NUMBER_TO_OPTION[last_key]:
                chosen_option = NUMBER_TO_OPTION[last_key][num_digits]
                answer = ALL_DETAILS.get(chosen_option, "ุนุฐุฑูุงุ ูุง ุชูุฌุฏ ุชูุงุตูู.")
                user_session["last_option_key"] = None
                history.append({"role": "assistant", "content": format_answer_with_images(answer)})
                return history, history, user_session, ""

        # 3. ุชุญููู ุงููููุงุช ุงูููุชุงุญูุฉ
        keyword = get_keyword(user_message)
        if keyword:
            final_answer = None
            
            # 1. ุงูุจุญุซ ูู ูุงููุณ ุงูุฅุฌุงุจุงุช ุงูุนุงูุฉ (FAQ) ุฃููุงู
            if keyword in faq:
                final_answer = faq[keyword]

            # 2. ุฅุฐุง ูู ูุฌุฏ ุฅุฌุงุจุฉ ูู FAQุ ูุจุญุซ ูู ุชูุงุตูู ุงูุฃูุงูู (ALL_DETAILS)
            if final_answer is None and keyword in ALL_DETAILS:
                detail = ALL_DETAILS[keyword]
                
                if isinstance(detail, dict) and "desc" in detail:
                    final_answer = detail["desc"]
                elif isinstance(detail, str):
                     final_answer = detail
        # ุงูุชุนุงูู ูุน ุงูููุงุฆู
        if keyword in PLACE_OPTIONS:
            user_session["last_option_key"] = keyword
            options_text = "\n".join([f"*{i+1}.* {opt}" for i, opt in enumerate(PLACE_OPTIONS[keyword]["options"])])
            answer = f"{PLACE_OPTIONS[keyword]['text']}\n{options_text}"
            history.append({"role": "assistant", "content": answer})
            return history, history, user_session, ""

        # ุงูุชุนุงูู ูุน ุงูุฃุณุฆูุฉ ุงููุจุงุดุฑุฉ (ูุซู "ููู ุงูุฃูู")
        if keyword and (keyword in ALL_DETAILS or keyword in faq):
            answer = ALL_DETAILS.get(keyword) or faq.get(keyword)
            history.append({"role": "assistant", "content": format_answer_with_images(answer)})
            user_session["last_option_key"] = None
            return history, history, user_session, ""

        # 4. ูุธุงู ุงููุณุงุฑุงุช (Routing)
        def extract_locations(text, synonyms_map):
            text = clean_text(text)
            found = []
            # ุชุฑุชูุจ ุงูููุงุชูุญ ุจุงูุฃุทูู ุฃููุงู ูุชุฌูุจ ุชุฏุงุฎู ุงููููุงุช (ูุซู ูุงูุชูุฑูุง ููููู)
            sorted_keys = sorted(synonyms_map.keys(), key=len, reverse=True)
            for key in sorted_keys:
                words = [key] + synonyms_map[key]
                for w in words:
                    if clean_text(w) in text:
                        if key not in found:
                            found.append(key)
                        break # ูุฌุฏูุง ูุฑุงุฏู ููุฐุง ุงูููุชุงุญุ ููุชูู ููููุชุงุญ ุงูุชุงูู
            return found

        places = extract_locations(user_message, synonym_map)

        # ุฅุฐุง ุฐูุฑ ููุงููู ูุฎุชูููู
        if len(places) >= 2 and places[0] != places[1]:
            start, end = places[0], places[1]
            route = ROUTES.get((start, end)) or ROUTES.get((end, start))
            if route:
                answer = f"๐บ๏ธ *ุงูุทุฑูู ูู {start} ุฅูู {end}:*\n{route}"
            else:
                answer = f"๐ซ ูุง ููุฌุฏ ูุณุงุฑ ูุณุฌู ูุจุงุดุฑุฉ ุจูู {start} ู {end}."
            history.append({"role": "assistant", "content": answer})
            return history, history, user_session, ""

        # ุฅุฐุง ุฐูุฑ ููุงู ูุงุญุฏ (ูููุณ ุณุคุงู "ุฃูู")
        if len(places) == 1:
            loc = places[0]
            # ููุง ูุนุงูุฌ ูุดููุฉ "ุฃุจู ูุณุงุฑ ูููููู" ูุงููุณุชุฎุฏู ูู ูุญุฏุฏ ุงูุจุฏุงูุฉ
            if "ุทุฑูู" in user_message or "ูุณุงุฑ" in user_message or "ูุตููู" in user_message:
                 answer = f"๐ ููู ุฃุตู ูู ุงูุทุฑูู ุฅูู *{loc}*ุ ูุฑุฌู ุฅุฎุจุงุฑู ุจููุงูู ุงูุญุงูู (ูุซุงู: ูู ุงูุจูุงุจุฉ 1 ุฅูู {loc})."
            else:
                 # ูุฌุฑุฏ ูุตู ููููุงู
                 desc = PLACES.get(loc, {}).get("desc", ALL_DETAILS.get(loc, f"ุฃูุช ุชุณุฃู ุนู {loc}."))
                 answer = f"{desc}"
            
            history.append({"role": "assistant", "content": format_answer_with_images(answer)})
            return history, history, user_session, ""

        # 5. ุงุณุชุฏุนุงุก Gemini (ูุฃู ุดูุก ุบูุฑ ูุนุฑูู)
        if GEMINI_ENABLED:
            local_context = "\n".join([f"{k}: {v}" for k, v in list(ALL_FAQ_KEYWORDS.items())[:25]])
            gemini_response = call_gemini_api(user_message, local_context_text=local_context)
            answer = f"๐ค {gemini_response}"
        else:
            answer = "โ๏ธ ุนุฐุฑูุงุ ูู ุฃููู ุงูุณุคุงู ุฌูุฏูุง. ูุฑุฌู ุงูุชูุถูุญ ุฃูุซุฑ."

        history.append({"role": "assistant", "content": answer})
        return history, history, user_session, ""

    except Exception as e:
        history.append({"role": "assistant", "content": f"โ๏ธ ุฎุทุฃ: {e}"})
        return history, history, user_session, ""


# ============================
# ูุงุฌูุฉ GRADIO
# ============================
app = gr.Blocks(title="ุฏุฑูุจ ุขููุฉ - ูุฑุดุฏ ุงููููุฉ ุงูุฐูู")

with app:

    gr.HTML("""
    <style>
    :root {
        --blue-primary: #004aad;
        --blue-light: #e6f0ff;
        --blue-medium: #b3d1ff;
    }
    .gradio-container { font-family: 'Cairo', sans-serif; background: var(--blue-light) !important; }
    .start-btn { background-color: var(--blue-primary) !important; color: white !important; border-radius: 20px; font-size: 20px; padding: 12px 50px; cursor: pointer; }
    .blue-btn { background-color: var(--blue-medium) !important; color: var(--blue-primary) !important; border-radius: 16px; border: 1px solid var(--blue-primary); font-weight: bold; }
    .primary-btn { background-color: var(--blue-primary) !important; color: white !important; border-radius: 16px; }
    .secondary-btn { background-color: #f0f0f0 !important; color: #333 !important; border-radius: 16px; border: 1px solid #ccc; }
    .share-btn { background-color: rgb(6,40,62) !important; color: white !important; border-radius: 16px; }
    .gradio-container .message.bot { background-color: #fff !important; border: 1px solid var(--blue-medium) !important; }
    .gradio-container .message.user { background-color: var(--blue-medium) !important; color: var(--blue-primary) !important; }
    </style>
    """)

    # Intro
    with gr.Column(visible=True) as intro_box:
        gr.Markdown("""
        <div style="text-align:center; padding: 40px; background-color: #fff; border-radius: 20px;">
            <h1 style='color: #004aad;'>๐ ุฏุฑูุจ ุขููุฉ - ุงููููุฉ ุงูุชูููุฉ ุงูุฑูููุฉ ุจุฌุฏุฉ ๐</h1>
            <p>
            ูุฑุญุจูุง ุจู ูู ุฑุญุงุจ ุงููููุฉ ุงูุชูููุฉ ุงูุฑูููุฉุ ุญูุซ ูุฏูุฌ ุงูุชูููุฉ ูุน ุงูุฅุจุฏุงุน ูุชุทููุฑ ููุงุฑุงุชู ูููุงูุจู.  
            ููุง ุณุชุฌุฏูู ุจูุฆุฉ ุชุนููููุฉ ุญุฏูุซุฉุ ููุฑุงูู ูููุฃุฉ ูุฏุนู ุฌููุน ุงูุทูุงุจุ ูุน ุณูููุฉ ุงููุตูู ูุงูุชููู ุฏุงุฎู ุงููุจูู.  
            ุงุณุชูุดูู ุฎุฏูุงุชูุง ูุงุณุฃูู ุฃู ุดูุก ุนู ุงููููุฉุ ูุณุฃููู ูุฑุดุฏู ุงูุฐูู ููุฅุฌุงุจุฉ ุนู ุงุณุชูุณุงุฑุงุชู! ๐
            </p>
        </div>
        """)
        start_btn = gr.Button("ุงุจุฏุฆู ุงูุขู ๐", elem_classes="start-btn")

    # Bot UI
    with gr.Column(visible=False) as bot_box:
        gr.Markdown("<h2 style='text-align:center;color:#004aad;'>๐ฌ ุฏุฑูุจ ุขููุฉ - ุงููุณุงุนุฏุฉ ุงูุฐููุฉ ๐ฌ</h2>")

        user_session = gr.State({"state": "NORMAL", "last_option_key": None})
        chatbot_history = gr.State(get_welcome_message())
        chatbot = gr.Chatbot(value=get_welcome_message(), label="ุงููุญุงุฏุซุฉ", render_markdown=True)
        message = gr.Textbox(label="ุงูุชุจู ุฑุณุงูุชู ููุง...", placeholder="ุงุณุฃูู ุฃู ุดูุก...", lines=1)

        # ุฃุฒุฑุงุฑ ุงูุฎูุงุฑุงุช ุงูุฑุฆูุณูุฉ
        with gr.Row():
            main_btns = [
                gr.Button("ููุงูู", elem_classes="blue-btn"), 
                gr.Button("ุจูุงุจุงุช", elem_classes="blue-btn"), 
                gr.Button("ูุทุนู ููููู", elem_classes="blue-btn"), 
                gr.Button("ุงูุนูุงุฏุฉ", elem_classes="blue-btn"), 
                gr.Button("ุงูููุชุจุฉ", elem_classes="blue-btn"), 
                gr.Button("ุณุงุญุฉ ุงููุฏุฑุจุงุช", elem_classes="blue-btn"), 
                gr.Button("ูุณุงุนุฏุฉ", elem_classes="blue-btn")
            ]

        # ุฃุฒุฑุงุฑ ุฅุฑุณุงู ููุณุญ ููุงุชุณุงุจ
        with gr.Row():
            send_button = gr.Button("ุฅุฑุณุงู", elem_classes="primary-btn")
            clear_btn = gr.Button("๐๏ธ ูุณุญ", elem_classes="secondary-btn")
            whatsapp_button = gr.Button("๐ฒ ูุงุชุณุงุจ", elem_classes="share-btn")

        outputs_list_chat = [chatbot, chatbot_history, user_session, message]

        # ุฑุจุท ุงูุฃุฒุฑุงุฑ ุจุงูุฏูุงู
        send_button.click(fn=chat, inputs=[message, chatbot_history, user_session],
                          outputs=outputs_list_chat)
        message.submit(fn=chat, inputs=[message, chatbot_history, user_session],
                       outputs=outputs_list_chat)
        clear_btn.click(fn=clear_all, inputs=None, outputs=outputs_list_chat)
        whatsapp_button.click(fn=launch_whatsapp_button, inputs=None, outputs=None)

        for btn in main_btns:
            btn.click(lambda v=btn: v.value, outputs=[message], queue=False).then(
                chat, [message, chatbot_history, user_session], outputs_list_chat
            )

    # ุฑุจุท ุฒุฑ ุงูุจุฏุงูุฉ ูุฅุฎูุงุก intro ูุฅุธูุงุฑ bot UI
    start_btn.click(fn=lambda: (gr.update(visible=False), gr.update(visible=True)),
                    outputs=[intro_box, bot_box])

if __name__ == "__main__":
    app.launch(share=True)
